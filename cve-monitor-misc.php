<?
	/*
	 *	Copyright 2019, Alex Pankratov. All rights reserved.
	 *
	 *	https://github.com/apankrat/cve-monitor
	 *
	 *	This code is distributed under terms of BSD license. 
	 *	You can obtain the copy of the license by visiting:
	 *
	 *	http://www.opensource.org/licenses/bsd-license.php
	 */
	class Logger
	{
		function __construct($file, $echo = false)
		{
			$this->file = $file;
			$this->echo = $echo;

			if ($echo) $this->test();
		}
   
		public function write($text)
		{
			if (! $text)
				return;

			if (substr($text, -1) != "\n")
				$text .= "\n";

			if (! $this->file && ! $this->echo)
				return;

			$text = strftime("%F %T ") . $text;

			$f = @fopen($this->file, 'a');
			if ($f)
			{
				fwrite($f, $text);
				fclose($f);
			}

			if ($this->echo)
				echo $text;
		}

		public function write_r($var)
		{
			$this->write( print_r($var, true) );
		}

		public function test()
		{
			$f = @fopen($this->file, 'a');
			if ($f)
			{
				fclose($f);
				return;
			}

			echo "** " . error_get_last()['message'] . "\n";
			echo "Log file is inaccessible\n";
		}

		private  $file;
		public   $echo;
	};

	//
	function expand_path($path)
	{
		if (strpos($path, '~') === false)
			return $path;

		$home = posix_getpwuid( posix_getuid() )['dir'];
		return str_replace('~', $home, $path);
	}

	function prep_folder($file)
	{
		global $log;

		$path = dirname($file);
		if (! $path)
			return;

		if (! file_exists($path))
		{
			$log->write("Creating $path/ ...");
			if ( ! @mkdir($path, 0755, true))
				alert_and_die('mkdir() failed, $path');
		}
		else
		if (! is_dir($path))
		{
			alert_and_die("$path exists and not a folder");
		}
	}

	//
	function alert($text)
	{
		global $log;
		$log->write("Sending alert - $text");
		mail(EMAIL_ALERT, "cvemon alert - $text", "", "From: " . EMAIL_FROM);
	}

	function alert_and_die($text)
	{
		alert($text);
		exit;
	}
?>
